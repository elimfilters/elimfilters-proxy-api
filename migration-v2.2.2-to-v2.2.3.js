// migration-v2.2.2-to-v2.2.3.js
// Script de migraci√≥n para corregir SKUs con las reglas actualizadas

require('dotenv').config();
const { google } = require('googleapis');

// ============================================================================
// MAPEO DE CORRECCIONES
// ============================================================================

const PREFIX_MIGRATIONS = {
  'EL9': 'EL8',  // OIL|LD
  'EF8': 'EF9',  // FUEL|HD
  'EA2': 'EA1',  // AIRE|LD (nota: EA2 ahora es CARCAZA AIR FILTER|HD)
  'EC2': 'EC1',  // CABIN|HD
  'ED1': 'ED4',  // AIR DRYER|HD
  'ET8': 'EW7',  // COOLANT|HD
  'EZ1': 'EA2',  // CARCAZA AIR FILTER|HD (cambio de letra y n√∫mero)
  'EB1': 'ET9',  // TURBINE SERIES|HD
  'EK8': 'EK5',  // KITS SERIES HD|HD
  'EK9': 'EK3'   // KITS SERIES LD|LD
};

// Combinaciones que ya no existen (se deben eliminar o revisar manualmente)
const DELETED_COMBINATIONS = [
  'FUEL SEPARATOR|LD',
  'AIR DRYER|LD',
  'COOLANT|LD',
  'CARCAZA AIR FILTER|LD',
  'TURBINE SERIES|LD'
];

// ============================================================================
// CONFIGURACI√ìN
// ============================================================================

const SHEET_ID = process.env.GOOGLE_SHEETS_ID || '1ZYI5c0enkuvWAveu8HMaCUk1cek_VDrX8GtgKW7VP6U';

// ============================================================================
// FUNCIONES DE GOOGLE SHEETS
// ============================================================================

async function getGoogleSheetsClient() {
  try {
    const credentials = JSON.parse(process.env.GOOGLE_CREDENTIALS);
    const auth = new google.auth.GoogleAuth({
      credentials,
      scopes: ['https://www.googleapis.com/auth/spreadsheets']
    });
    
    return google.sheets({ version: 'v4', auth });
  } catch (error) {
    console.error('‚ùå Error creating Google Sheets client:', error.message);
    throw error;
  }
}

async function getAllFilters(sheets) {
  console.log('üìä Leyendo todos los filtros del Sheet...');
  
  const response = await sheets.spreadsheets.values.get({
    spreadsheetId: SHEET_ID,
    range: 'FILTERS!A2:AF'
  });
  
  const rows = response.data.values || [];
  console.log(`   Encontrados: ${rows.length} filtros`);
  
  return rows.map((row, index) => ({
    rowNumber: index + 2, // +2 porque row 1 son headers y empezamos en 2
    sku: row[0] || '',
    oem_code: row[1] || '',
    family: row[2] || '',
    duty: row[3] || '',
    specs_summary: row[4] || '',
    cross_reference: row[5] || '',
    fullRow: row
  }));
}

// ============================================================================
// FUNCIONES DE AN√ÅLISIS
// ============================================================================

function analyzeFilter(filter) {
  const { sku, family, duty } = filter;
  
  if (!sku || sku.length < 5) {
    return { needsMigration: false, reason: 'No SKU or too short' };
  }
  
  const prefix = sku.substring(0, 3);
  const last4 = sku.substring(3);
  
  // Verificar si el prefix necesita migraci√≥n
  const newPrefix = PREFIX_MIGRATIONS[prefix];
  if (newPrefix) {
    return {
      needsMigration: true,
      type: 'prefix_change',
      oldPrefix: prefix,
      newPrefix: newPrefix,
      oldSKU: sku,
      newSKU: `${newPrefix}${last4}`,
      family: family,
      duty: duty
    };
  }
  
  // Verificar si es una combinaci√≥n eliminada
  const combination = `${family}|${duty}`;
  if (DELETED_COMBINATIONS.includes(combination)) {
    return {
      needsMigration: true,
      type: 'deleted_combination',
      combination: combination,
      reason: 'Esta combinaci√≥n ya no existe en las reglas',
      action: 'MANUAL_REVIEW_REQUIRED'
    };
  }
  
  // Caso especial: AIRE|LD con EA2 debe cambiar a EA1
  if (family === 'AIRE' && duty === 'LD' && prefix === 'EA2') {
    return {
      needsMigration: true,
      type: 'special_case_AIRE_LD',
      oldPrefix: 'EA2',
      newPrefix: 'EA1',
      oldSKU: sku,
      newSKU: `EA1${last4}`,
      note: 'AIRE|LD ahora usa EA1'
    };
  }
  
  return { needsMigration: false, reason: 'SKU is correct' };
}

// ============================================================================
// FUNCI√ìN PRINCIPAL DE MIGRACI√ìN
// ============================================================================

async function migrate(dryRun = true) {
  console.log('\n' + '='.repeat(70));
  console.log('üîÑ MIGRACI√ìN v2.2.2 ‚Üí v2.2.3');
  console.log('   Correcci√≥n de SKUs seg√∫n reglas actualizadas');
  console.log('='.repeat(70));
  console.log(`\nüìã Modo: ${dryRun ? 'DRY RUN (simulaci√≥n)' : 'REAL (aplicar√° cambios)'}\n`);
  
  const sheets = await getGoogleSheetsClient();
  const filters = await getAllFilters(sheets);
  
  console.log('\nüîç Analizando filtros...\n');
  
  const migrations = [];
  const deletedCombinations = [];
  const correct = [];
  
  filters.forEach(filter => {
    const analysis = analyzeFilter(filter);
    
    if (analysis.needsMigration) {
      if (analysis.type === 'deleted_combination') {
        deletedCombinations.push({ filter, analysis });
      } else {
        migrations.push({ filter, analysis });
      }
    } else {
      correct.push(filter);
    }
  });
  
  // ============================================================================
  // REPORTE
  // ============================================================================
  
  console.log('üìä RESUMEN DEL AN√ÅLISIS:\n');
  console.log(`   ‚úÖ Correctos:                  ${correct.length}`);
  console.log(`   üîÑ Requieren migraci√≥n:        ${migrations.length}`);
  console.log(`   ‚ö†Ô∏è  Combinaciones eliminadas:  ${deletedCombinations.length}`);
  console.log(`   üìù Total analizado:            ${filters.length}\n`);
  
  // ============================================================================
  // MIGRACIONES POR PREFIX
  // ============================================================================
  
  if (migrations.length > 0) {
    console.log('üîÑ CAMBIOS DE PREFIX:\n');
    
    const byPrefix = {};
    migrations.forEach(({ analysis }) => {
      const key = `${analysis.oldPrefix} ‚Üí ${analysis.newPrefix}`;
      if (!byPrefix[key]) byPrefix[key] = [];
      byPrefix[key].push(analysis);
    });
    
    Object.entries(byPrefix).forEach(([change, items]) => {
      console.log(`   ${change}: ${items.length} filtros`);
      items.slice(0, 3).forEach(item => {
        console.log(`      ${item.oldSKU} ‚Üí ${item.newSKU} (${item.family}|${item.duty})`);
      });
      if (items.length > 3) {
        console.log(`      ... y ${items.length - 3} m√°s`);
      }
      console.log('');
    });
  }
  
  // ============================================================================
  // COMBINACIONES ELIMINADAS
  // ============================================================================
  
  if (deletedCombinations.length > 0) {
    console.log('‚ö†Ô∏è  COMBINACIONES QUE YA NO EXISTEN:\n');
    
    deletedCombinations.forEach(({ filter, analysis }) => {
      console.log(`   SKU: ${filter.sku}`);
      console.log(`   Combinaci√≥n: ${analysis.combination}`);
      console.log(`   Raz√≥n: ${analysis.reason}`);
      console.log(`   Acci√≥n: Revisar manualmente\n`);
    });
  }
  
  // ============================================================================
  // APLICAR CAMBIOS (si no es dry run)
  // ============================================================================
  
  if (!dryRun && migrations.length > 0) {
    console.log('\nüöÄ Aplicando cambios al Google Sheet...\n');
    
    const updates = migrations.map(({ filter, analysis }) => ({
      range: `FILTERS!A${filter.rowNumber}`,
      values: [[analysis.newSKU]]
    }));
    
    // Aplicar en batches de 100
    const batchSize = 100;
    for (let i = 0; i < updates.length; i += batchSize) {
      const batch = updates.slice(i, i + batchSize);
      
      await sheets.spreadsheets.values.batchUpdate({
        spreadsheetId: SHEET_ID,
        requestBody: {
          valueInputOption: 'RAW',
          data: batch
        }
      });
      
      console.log(`   ‚úÖ Actualizados ${Math.min(i + batchSize, updates.length)}/${updates.length}`);
    }
    
    console.log('\n‚úÖ Migraci√≥n completada!');
  } else if (dryRun) {
    console.log('\nüí° Esta fue una simulaci√≥n. Para aplicar los cambios:');
    console.log('   node migration-v2.2.2-to-v2.2.3.js --apply\n');
  }
  
  // ============================================================================
  // EXPORTAR REPORTE
  // ============================================================================
  
  const report = {
    date: new Date().toISOString(),
    dryRun: dryRun,
    summary: {
      total: filters.length,
      correct: correct.length,
      migrations: migrations.length,
      deletedCombinations: deletedCombinations.length
    },
    migrations: migrations.map(({ filter, analysis }) => ({
      rowNumber: filter.rowNumber,
      oem_code: filter.oem_code,
      family: filter.family,
      duty: filter.duty,
      oldSKU: analysis.oldSKU,
      newSKU: analysis.newSKU,
      oldPrefix: analysis.oldPrefix,
      newPrefix: analysis.newPrefix
    })),
    deletedCombinations: deletedCombinations.map(({ filter, analysis }) => ({
      rowNumber: filter.rowNumber,
      sku: filter.sku,
      oem_code: filter.oem_code,
      combination: analysis.combination,
      reason: analysis.reason
    }))
  };
  
  const fs = require('fs');
  const reportFile = `migration-report-${new Date().toISOString().split('T')[0]}.json`;
  fs.writeFileSync(reportFile, JSON.stringify(report, null, 2));
  console.log(`\nüìÑ Reporte guardado: ${reportFile}\n`);
  
  return report;
}

// ============================================================================
// EJECUTAR
// ============================================================================

if (require.main === module) {
  const args = process.argv.slice(2);
  const apply = args.includes('--apply') || args.includes('-a');
  const dryRun = !apply;
  
  migrate(dryRun).catch(error => {
    console.error('\n‚ùå Error en migraci√≥n:', error.message);
    console.error(error.stack);
    process.exit(1);
  });
}

module.exports = { migrate, analyzeFilter, PREFIX_MIGRATIONS, DELETED_COMBINATIONS };
